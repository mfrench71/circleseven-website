<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comments - Admin</title>
  <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Local CSS -->
  <link rel="stylesheet" href="/admin/admin.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-light">
  <div id="app">
    <!-- Auth Gate -->
    <div id="auth-gate" class="min-vh-100 d-flex align-items-center justify-content-center">
      <div class="card shadow p-4 auth-gate-card">
        <h1 class="h3 fw-bold mb-3">Admin Login Required</h1>
        <p class="text-muted mb-3">Please log in to access comments moderation.</p>
        <button onclick="netlifyIdentity.open()" class="btn btn-primary w-100">
          Log In
        </button>
      </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="d-none">
      <!-- Header Container (populated by shared component) -->
      <div id="header-container"></div>

      <!-- Sidebar Container (populated by shared component) -->
      <div id="sidebar-container"></div>

      <!-- Main Content Area (adjusted for sidebar, below header) -->
      <div id="main-content-wrapper">
        <!-- Main Content -->
        <main class="px-3 px-lg-4 py-4">
          <!-- Error State -->
          <div id="error" class="alert alert-danger d-none mb-4" role="alert">
            <p class="mb-0"></p>
          </div>

          <!-- Success State -->
          <div id="success" class="alert alert-success d-none mb-4" role="alert">
            <p class="mb-0"></p>
          </div>

          <h2 class="h5 fw-bold mb-4">Comments</h2>

          <!-- Filter Tabs -->
          <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pending-tab" onclick="switchFilter('pending')" type="button">
                <i class="fas fa-clock me-1"></i>
                Pending
                <span id="pending-count" class="badge bg-warning ms-1">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="approved-tab" onclick="switchFilter('approved')" type="button">
                <i class="fas fa-check-circle me-1"></i>
                Approved
                <span id="approved-count" class="badge bg-success ms-1">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="all-tab" onclick="switchFilter('all')" type="button">
                <i class="fas fa-comments me-1"></i>
                All
                <span id="all-count" class="badge bg-secondary ms-1">0</span>
              </button>
            </li>
          </ul>

          <!-- Comments Section -->
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <div id="comments-loading" class="text-center py-5 text-muted">
                <div class="spinner-border text-primary mb-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Loading comments...</p>
              </div>
              <div id="comments-list" class="d-none">
                <!-- Comments will be rendered here -->
              </div>
              <div id="comments-empty" class="d-none text-center py-4 text-muted">
                <i class="fas fa-check-circle fa-3x mb-2"></i>
                <p class="mb-0">No comments found.</p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Import logger to make it available globally for app.js -->
  <script type="module">
    import logger from '/admin/js/core/logger.js?v=1761218399';
  </script>

  <script src="/admin/app.js?v=1761218399"></script>

  <!-- ES6 Modules Integration -->
  <script type="module">
    // Import standalone init helper
    import { initStandalonePage } from '/admin/js/standalone-init.js?v=1761218399';

    // Import shared components
    import { initHeader } from '/admin/js/components/header.js?v=1761218399';
    import { initSidebar } from '/admin/js/components/sidebar.js?v=1761218399';

    // Import modules
    import { initNotifications } from '/admin/js/ui/notifications.js?v=1761218399';
    import { loadSiteTitle } from '/admin/js/modules/settings.js?v=1761218399';
    import {
      loadDeploymentHistory,
      restoreActiveDeployments,
      trackDeployment,
      showDeploymentBanner,
      updateDeploymentBanner,
      showDeploymentCompletion,
      hideDeploymentBanner,
      startDeploymentPolling
    } from '/admin/js/modules/deployments.js?v=1761218399';

    // Initialize notifications when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNotifications);
    } else {
      initNotifications();
    }

    // Expose to window
    window.loadSiteTitle = loadSiteTitle;
    window.loadDeploymentHistory = loadDeploymentHistory;
    window.restoreActiveDeployments = restoreActiveDeployments;
    window.trackDeployment = trackDeployment;
    window.showDeploymentBanner = showDeploymentBanner;
    window.updateDeploymentBanner = updateDeploymentBanner;
    window.showDeploymentCompletion = showDeploymentCompletion;
    window.hideDeploymentBanner = hideDeploymentBanner;
    window.startDeploymentPolling = startDeploymentPolling;

    // Page-specific initialization
    const init = async () => {
      await initStandalonePage('comments', async (user) => {
        // Initialize shared components with active page
        initHeader();
        initSidebar('comments');

        // Load site title
        await loadSiteTitle();

        // Load deployment history and restore active deployments
        await loadDeploymentHistory();
        await restoreActiveDeployments();

        // Load comments
        await loadComments();
      });
    };

    // Current filter state
    let currentFilter = 'pending';

    // Switch filter tab
    window.switchFilter = function(filter) {
      currentFilter = filter;

      // Update tab states
      document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`${filter}-tab`).classList.add('active');

      // Reload comments with new filter
      loadComments(filter);
    };

    // Load comments from API
    window.loadComments = async function(filter = 'pending') {
      const loadingEl = document.getElementById('comments-loading');
      const listEl = document.getElementById('comments-list');
      const emptyEl = document.getElementById('comments-empty');

      // Show loading state
      loadingEl.classList.remove('d-none');
      listEl.classList.add('d-none');
      emptyEl.classList.add('d-none');

      try {
        // Fetch all comments to get counts for all tabs
        const [pendingRes, approvedRes, allRes] = await Promise.all([
          fetch('/.netlify/functions/comments-moderate?filter=pending'),
          fetch('/.netlify/functions/comments-moderate?filter=approved'),
          fetch('/.netlify/functions/comments-moderate?filter=all')
        ]);

        if (!pendingRes.ok || !approvedRes.ok || !allRes.ok) {
          throw new Error('Failed to load comments');
        }

        const [pendingData, approvedData, allData] = await Promise.all([
          pendingRes.json(),
          approvedRes.json(),
          allRes.json()
        ]);

        // Update all counts
        document.getElementById('pending-count').textContent = pendingData.count || 0;
        document.getElementById('approved-count').textContent = approvedData.count || 0;
        document.getElementById('all-count').textContent = allData.count || 0;

        // Get comments for current filter
        let comments = [];
        if (filter === 'pending') {
          comments = pendingData.comments || [];
        } else if (filter === 'approved') {
          comments = approvedData.comments || [];
        } else {
          comments = allData.comments || [];
        }

        // Hide loading
        loadingEl.classList.add('d-none');

        if (comments.length === 0) {
          emptyEl.classList.remove('d-none');
        } else {
          listEl.classList.remove('d-none');
          renderComments(comments, listEl);
        }
      } catch (error) {
        console.error('Failed to load comments:', error);
        loadingEl.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
            <p class="fs-5 fw-medium mb-2">Failed to load comments</p>
            <p class="mb-0">${error.message}</p>
          </div>
        `;
      }
    };

    // Render comments list
    function renderComments(comments, container) {
      container.innerHTML = comments.map(comment => {
        const isApproved = comment.approved === true;
        const statusBadge = isApproved
          ? '<span class="badge bg-success">Approved</span>'
          : '<span class="badge bg-warning">Pending</span>';

        const actions = isApproved
          ? `<button onclick="deleteComment('${comment.id}', '${comment.postSlug}')" class="btn btn-danger btn-sm">
               <i class="fas fa-trash me-1"></i>
               Delete
             </button>`
          : `<button onclick="approveComment('${comment.id}', '${comment.postSlug}')" class="btn btn-success btn-sm">
               <i class="fas fa-check me-1"></i>
               Approve
             </button>
             <button onclick="rejectComment('${comment.id}', '${comment.postSlug}')" class="btn btn-danger btn-sm">
               <i class="fas fa-times me-1"></i>
               Reject
             </button>`;

        return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="h6 fw-bold mb-1">Comment on: ${escapeHtml(comment.postSlug)}</h5>
                  <p class="text-muted small mb-0">
                    <i class="fas fa-user me-1"></i>
                    By ${escapeHtml(comment.name)}
                    <span class="mx-2">•</span>
                    <i class="fas fa-clock me-1"></i>
                    ${new Date(comment.date).toLocaleString()}
                    ${isApproved ? `<span class="mx-2">•</span><i class="fas fa-check-circle me-1"></i>${new Date(comment.approvedAt).toLocaleString()}` : ''}
                  </p>
                </div>
                ${statusBadge}
              </div>
              <div class="bg-light p-3 rounded mb-3">
                <p class="mb-0 text-break">${escapeHtml(comment.message).replace(/\n/g, '<br>')}</p>
              </div>
              <div class="d-flex gap-2">
                ${actions}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Approve comment
    window.approveComment = async function(commentId, postSlug) {
      if (!confirm('Approve this comment? It will be published immediately.')) {
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/comments-moderate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'approve', commentId, postSlug })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to approve comment');
        }

        // Show success message
        const successEl = document.getElementById('success');
        successEl.querySelector('p').textContent = '✓ Comment approved successfully!';
        successEl.classList.remove('d-none');
        setTimeout(() => successEl.classList.add('d-none'), 3000);

        // Reload comments with current filter
        await loadComments(currentFilter);
      } catch (error) {
        const errorEl = document.getElementById('error');
        errorEl.querySelector('p').textContent = error.message;
        errorEl.classList.remove('d-none');
        setTimeout(() => errorEl.classList.add('d-none'), 5000);
      }
    };

    // Reject comment
    window.rejectComment = async function(commentId, postSlug) {
      if (!confirm('Reject this comment? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/comments-moderate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reject', commentId, postSlug })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to reject comment');
        }

        // Show success message
        const successEl = document.getElementById('success');
        successEl.querySelector('p').textContent = '✓ Comment rejected successfully.';
        successEl.classList.remove('d-none');
        setTimeout(() => successEl.classList.add('d-none'), 3000);

        // Reload comments with current filter
        await loadComments(currentFilter);
      } catch (error) {
        const errorEl = document.getElementById('error');
        errorEl.querySelector('p').textContent = error.message;
        errorEl.classList.remove('d-none');
        setTimeout(() => errorEl.classList.add('d-none'), 5000);
      }
    };

    // Delete comment (for approved comments)
    window.deleteComment = async function(commentId, postSlug) {
      if (!confirm('Delete this comment permanently? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/.netlify/functions/comments-moderate?commentId=${encodeURIComponent(commentId)}&postSlug=${encodeURIComponent(postSlug)}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to delete comment');
        }

        // Show success message
        const successEl = document.getElementById('success');
        successEl.querySelector('p').textContent = '✓ Comment deleted successfully.';
        successEl.classList.remove('d-none');
        setTimeout(() => successEl.classList.add('d-none'), 3000);

        // Reload comments with current filter
        await loadComments(currentFilter);
      } catch (error) {
        const errorEl = document.getElementById('error');
        errorEl.querySelector('p').textContent = error.message;
        errorEl.classList.remove('d-none');
        setTimeout(() => errorEl.classList.add('d-none'), 5000);
      }
    };

    // HTML escape helper
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    // NO login/logout event handlers here - initStandalonePage handles authentication
  </script>
</body>
</html>
