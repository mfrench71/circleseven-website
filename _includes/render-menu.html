{%- comment -%}
  Dynamic Menu Renderer

  Renders menus from _data/menus.yml with support for:
  - category_ref: Categories referenced from taxonomy
  - page: Static pages
  - custom: Custom links
  - heading: Section headers (creates sections/columns in mega menus)

  Parameters:
  - menu_items: Array of menu items from menus.yml
  - menu_type: "desktop" or "mobile"
{%- endcomment -%}

{%- comment -%} DESKTOP MEGA MENU RENDERING {%- endcomment -%}
{%- if include.menu_type == "desktop" -%}
  <ul class="nav-list">
  {%- for menu_item in include.menu_items -%}

    {%- comment -%} Resolve category_ref items {%- endcomment -%}
    {%- if menu_item.type == "category_ref" -%}
      {%- assign category_slug = menu_item.category_ref -%}
      {%- assign resolved_label = nil -%}
      {%- assign resolved_url = nil -%}
      {%- assign post_count = 0 -%}

      {%- for cat in site.data.taxonomy.categories -%}
        {%- assign cat_slug = cat.slug | default: cat.item | slugify -%}
        {%- if cat_slug == category_slug -%}
          {%- assign resolved_label = cat.item -%}
          {%- assign resolved_url = site.baseurl | append: "/category/" | append: cat_slug | append: "/" -%}
          {%- assign post_count = site.categories[cat.item] | size -%}
          {%- break -%}
        {%- endif -%}
        {%- if cat.children -%}
          {%- for child in cat.children -%}
            {%- assign child_slug = child.slug | default: child.item | slugify -%}
            {%- if child_slug == category_slug -%}
              {%- assign resolved_label = child.item -%}
              {%- assign resolved_url = site.baseurl | append: "/category/" | append: child_slug | append: "/" -%}
              {%- assign post_count = site.categories[child.item] | size -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}

      {%- assign item_label = menu_item.label | default: resolved_label -%}
      {%- assign item_url = menu_item.url | default: resolved_url -%}
    {%- else -%}
      {%- assign item_label = menu_item.label -%}
      {%- assign item_url = menu_item.url -%}
      {%- assign post_count = 0 -%}
    {%- endif -%}

    {%- comment -%} Check if this item has children (mega menu) {%- endcomment -%}
    {%- assign has_children = false -%}
    {%- if menu_item.children and menu_item.children.size > 0 -%}
      {%- assign has_children = true -%}
    {%- endif -%}

    {%- if has_children and menu_item.mega_menu -%}
      {%- comment -%} Desktop mega menu dropdown {%- endcomment -%}
      <li class="nav-item has-dropdown">
        <a href="{{ item_url }}" class="nav-link">
          {{ item_label }}
          {%- if post_count > 0 -%}
            <span class="post-count">{{ post_count }}</span>
          {%- endif -%}
          <i class="fas fa-chevron-down"></i>
        </a>
        <div class="mega-menu">
          <div class="mega-menu-content">
            {%- comment -%} Group items by sections (headings create new sections) {%- endcomment -%}
            {%- assign current_section_items = "" | split: "," -%}
            {%- assign current_section_heading = nil -%}
            {%- assign current_section_icon = nil -%}

            {%- for child in menu_item.children -%}
              {%- if child.type == "heading" -%}
                {%- comment -%} Output previous section if exists {%- endcomment -%}
                {%- if current_section_items.size > 0 -%}
                  <div class="mega-menu-section">
                    {%- if current_section_heading -%}
                      <h3>
                        {%- if current_section_icon -%}<i class="{{ current_section_icon }}" aria-hidden="true"></i> {%- endif -%}
                        {{ current_section_heading }}
                      </h3>
                    {%- endif -%}
                    <ul class="mega-menu-links">
                      {%- for item in current_section_items -%}
                        {{ item }}
                      {%- endfor -%}
                    </ul>
                  </div>
                {%- endif -%}

                {%- comment -%} Start new section {%- endcomment -%}
                {%- assign current_section_heading = child.label -%}
                {%- assign current_section_icon = child.icon -%}
                {%- assign current_section_items = "" | split: "," -%}
              {%- else -%}
                {%- comment -%} Resolve child item {%- endcomment -%}
                {%- if child.type == "category_ref" -%}
                  {%- assign child_category_slug = child.category_ref -%}
                  {%- assign child_resolved_label = nil -%}
                  {%- assign child_resolved_url = nil -%}
                  {%- assign child_post_count = 0 -%}

                  {%- for cat in site.data.taxonomy.categories -%}
                    {%- assign cat_slug = cat.slug | default: cat.item | slugify -%}
                    {%- if cat_slug == child_category_slug -%}
                      {%- assign child_resolved_label = cat.item -%}
                      {%- assign child_resolved_url = site.baseurl | append: "/category/" | append: cat_slug | append: "/" -%}
                      {%- assign child_post_count = site.categories[cat.item] | size -%}
                      {%- break -%}
                    {%- endif -%}
                    {%- if cat.children -%}
                      {%- for grandchild in cat.children -%}
                        {%- assign grandchild_slug = grandchild.slug | default: grandchild.item | slugify -%}
                        {%- if grandchild_slug == child_category_slug -%}
                          {%- assign child_resolved_label = grandchild.item -%}
                          {%- assign child_resolved_url = site.baseurl | append: "/category/" | append: grandchild_slug | append: "/" -%}
                          {%- assign child_post_count = site.categories[grandchild.item] | size -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- assign child_item_label = child.label | default: child_resolved_label -%}
                  {%- assign child_item_url = child.url | default: child_resolved_url -%}
                  {%- assign child_item_post_count = child_post_count -%}
                {%- else -%}
                  {%- assign child_item_label = child.label -%}
                  {%- assign child_item_url = child.url -%}
                  {%- assign child_item_post_count = 0 -%}
                {%- endif -%}

                {%- comment -%} Build link HTML as string {%- endcomment -%}
                {%- capture link_html -%}
                  <li>
                    <a href="{{ child_item_url }}"{% if child.type == "custom" %} target="_blank" rel="noopener"{% endif %}>
                      <span class="link-text">{{ child_item_label }}</span>
                      {%- if child_item_post_count > 0 -%}
                        <span class="post-count">{{ child_item_post_count }}</span>
                      {%- endif -%}
                    </a>
                  </li>
                {%- endcapture -%}
                {%- assign current_section_items = current_section_items | push: link_html -%}
              {%- endif -%}
            {%- endfor -%}

            {%- comment -%} Output final section {%- endcomment -%}
            {%- if current_section_items.size > 0 -%}
              <div class="mega-menu-section">
                {%- if current_section_heading -%}
                  <h3>
                    {%- if current_section_icon -%}<i class="{{ current_section_icon }}" aria-hidden="true"></i> {%- endif -%}
                    {{ current_section_heading }}
                  </h3>
                {%- endif -%}
                <ul class="mega-menu-links">
                  {%- for item in current_section_items -%}
                    {{ item }}
                  {%- endfor -%}
                </ul>
              </div>
            {%- endif -%}
          </div>
        </div>
      </li>
    {%- else -%}
      {%- comment -%} Regular nav item without dropdown {%- endcomment -%}
      <li class="nav-item">
        <a href="{{ item_url }}"{% if menu_item.type == "custom" %} target="_blank" rel="noopener"{% endif %}>
          {{ item_label }}
          {%- if post_count > 0 -%}
            <span class="post-count">{{ post_count }}</span>
          {%- endif -%}
        </a>
      </li>
    {%- endif -%}

  {%- endfor -%}
  </ul>

{%- comment -%} MOBILE MENU RENDERING {%- endcomment -%}
{%- elsif include.menu_type == "mobile" -%}
  <ul class="mobile-nav-list">
  {%- for menu_item in include.menu_items -%}

    {%- comment -%} Resolve category_ref items {%- endcomment -%}
    {%- if menu_item.type == "category_ref" -%}
      {%- assign category_slug = menu_item.category_ref -%}
      {%- assign resolved_label = nil -%}
      {%- assign resolved_url = nil -%}
      {%- assign post_count = 0 -%}

      {%- for cat in site.data.taxonomy.categories -%}
        {%- assign cat_slug = cat.slug | default: cat.item | slugify -%}
        {%- if cat_slug == category_slug -%}
          {%- assign resolved_label = cat.item -%}
          {%- assign resolved_url = site.baseurl | append: "/category/" | append: cat_slug | append: "/" -%}
          {%- assign post_count = site.categories[cat.item] | size -%}
          {%- break -%}
        {%- endif -%}
        {%- if cat.children -%}
          {%- for child in cat.children -%}
            {%- assign child_slug = child.slug | default: child.item | slugify -%}
            {%- if child_slug == category_slug -%}
              {%- assign resolved_label = child.item -%}
              {%- assign resolved_url = site.baseurl | append: "/category/" | append: child_slug | append: "/" -%}
              {%- assign post_count = site.categories[child.item] | size -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}

      {%- assign item_label = menu_item.label | default: resolved_label -%}
      {%- assign item_url = menu_item.url | default: resolved_url -%}
    {%- else -%}
      {%- assign item_label = menu_item.label -%}
      {%- assign item_url = menu_item.url -%}
      {%- assign post_count = 0 -%}
    {%- endif -%}

    {%- assign has_children = false -%}
    {%- if menu_item.children and menu_item.children.size > 0 -%}
      {%- assign has_children = true -%}
    {%- endif -%}

    {%- if menu_item.type == "heading" -%}
      {%- comment -%} Skip headings in mobile - they're not used {%- endcomment -%}
    {%- elsif has_children and menu_item.accordion -%}
      {%- comment -%} Mobile accordion {%- endcomment -%}
      <li class="mobile-nav-item">
        <button class="mobile-accordion-toggle" aria-expanded="false">
          {{ item_label }}
        </button>
        <div class="mobile-accordion-content">
          <ul class="mobile-accordion-links">
            {%- for child in menu_item.children -%}
              {%- if child.type != "heading" -%}
                {%- comment -%} Resolve child item {%- endcomment -%}
                {%- if child.type == "category_ref" -%}
                  {%- assign child_category_slug = child.category_ref -%}
                  {%- assign child_resolved_label = nil -%}
                  {%- assign child_resolved_url = nil -%}
                  {%- assign child_post_count = 0 -%}

                  {%- for cat in site.data.taxonomy.categories -%}
                    {%- assign cat_slug = cat.slug | default: cat.item | slugify -%}
                    {%- if cat_slug == child_category_slug -%}
                      {%- assign child_resolved_label = cat.item -%}
                      {%- assign child_resolved_url = site.baseurl | append: "/category/" | append: cat_slug | append: "/" -%}
                      {%- assign child_post_count = site.categories[cat.item] | size -%}
                      {%- break -%}
                    {%- endif -%}
                    {%- if cat.children -%}
                      {%- for grandchild in cat.children -%}
                        {%- assign grandchild_slug = grandchild.slug | default: grandchild.item | slugify -%}
                        {%- if grandchild_slug == child_category_slug -%}
                          {%- assign child_resolved_label = grandchild.item -%}
                          {%- assign child_resolved_url = site.baseurl | append: "/category/" | append: grandchild_slug | append: "/" -%}
                          {%- assign child_post_count = site.categories[grandchild.item] | size -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- assign child_item_label = child.label | default: child_resolved_label -%}
                  {%- assign child_item_url = child.url | default: child_resolved_url -%}
                  {%- assign child_item_post_count = child_post_count -%}
                {%- else -%}
                  {%- assign child_item_label = child.label -%}
                  {%- assign child_item_url = child.url -%}
                  {%- assign child_item_post_count = 0 -%}
                {%- endif -%}

                <li>
                  <a href="{{ child_item_url }}"{% if child.type == "custom" %} target="_blank" rel="noopener"{% endif %}>
                    <span class="link-text">{{ child_item_label }}</span>
                    {%- if child_item_post_count > 0 -%}
                      <span class="post-count">{{ child_item_post_count }}</span>
                    {%- endif -%}
                  </a>
                </li>
              {%- endif -%}
            {%- endfor -%}
          </ul>
        </div>
      </li>
    {%- else -%}
      {%- comment -%} Regular mobile nav item {%- endcomment -%}
      <li class="mobile-nav-item">
        <a href="{{ item_url }}"{% if menu_item.type == "custom" %} target="_blank" rel="noopener"{% endif %}>
          {{ item_label }}
          {%- if post_count > 0 -%}
            <span class="post-count">{{ post_count }}</span>
          {%- endif -%}
        </a>
      </li>
    {%- endif -%}

  {%- endfor -%}
  </ul>

{%- endif -%}
